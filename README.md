# Repo Health Analyzer

[![uv](https://img.shields.io/badge/uv-0.1.0-blue.svg)](https://github.com/astral-sh/uv)
[![Python 3.9+](https://img.shields.io/badge/python-3.9+-blue.svg)](https://www.python.org/downloads/)
[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)

This project provides a system to analyze the health of a GitHub repository over time. It collects raw pull request (PR) and issue data using GitHub GraphQL, normalizes it, and generates detailed metrics such as contributor activity, merge times, response times, backlog, and new contributor growth. The system is designed to be run incrementally on a weekly basis, providing a historical and rolling view of repository health.

---

## âœ¨ Features

* **Historical Data Analysis**: Bootstraps and analyzes repository data from a configurable start date.
* **Comprehensive Metrics**: Calculates strategy, execution, community, and backlog metrics.
* **Time-Series Analysis**: Provides monthly and rolling window metrics for trend analysis.
* **Robust Contributor Tracking**: Tracks contributors using a persistent GitHub User ID, ensuring accuracy even if accounts are deleted or renamed.
* **Deterministic Scoring**: Provides a 0-100 health score based on configurable targets for execution, community, and backlog health.
* **Risk Analysis**: Automatically flags potential issues like aging PRs and a large backlog.
* **Lean LLM Summaries**: Generates a small, focused summary report specifically for efficient LLM input.
* **Backlog Cleanup Tools**: Includes a script to help propose labels for open issues and PRs to aid in backlog management.
* **LLM Integration**: Generates a narrative Markdown report from the data using the `routstr` service.
* **CLI-First**: A clean, modern command-line interface built with `click`.
* **Modern Tooling**: Uses `uv` for fast, reliable dependency management and packaging.

---

## ğŸ“ Project Structure

The project is structured as a proper Python package for better maintainability and scalability.

```
repo-health-analyzer/
â”‚
â”œâ”€â”€ .env.example               # Template for environment variables
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”œâ”€â”€ label_taxonomy.json        # Configuration for the cleanup proposal script
â”œâ”€â”€ pyproject.toml             # Project metadata and dependencies
â”œâ”€â”€ uv.lock                    # Lock file generated by uv
â”‚
â”œâ”€â”€ src/
â”‚   â””â”€â”€ repo_health/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ __main__.py        # Entry point for CLI
â”‚       â”œâ”€â”€ cli/               # Command-line interface modules
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ fetch.py       # CLI command for fetching data
â”‚       â”‚   â”œâ”€â”€ generate.py    # CLI command for generating metrics
â”‚       â”‚   â”œâ”€â”€ score.py       # CLI command for calculating score
â”‚       â”‚   â”œâ”€â”€ report.py      # CLI command for generating final report
â”‚       â”‚   â””â”€â”€ summary.py     # CLI command for generating lean summary
â”‚       â”œâ”€â”€ config/            # Configuration management
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â””â”€â”€ settings.py    # Settings and environment variables
â”‚       â”œâ”€â”€ data/              # Data processing modules
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â””â”€â”€ fetcher.py     # GraphQL data fetcher and normalizer
â”‚       â”œâ”€â”€ engine/            # Metrics calculation and reporting
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ metrics.py     # Metrics calculation logic
â”‚       â”‚   â”œâ”€â”€ reporter.py    # Report generation
â”‚       â”‚   â”œâ”€â”€ scorer.py      # Deterministic scoring logic
â”‚       â”‚   â””â”€â”€ final_reporter.py # Comprehensive report generation
â”‚       â””â”€â”€ utils/             # Utility functions
â”‚           â”œâ”€â”€ __init__.py
â”‚           â””â”€â”€ helpers.py     # Common helper functions
â”‚
â”œâ”€â”€ tests/                     # Test directory
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ data/                      # Data directory (not in package)
â”‚   â”œâ”€â”€ prs_raw.json
â”‚   â””â”€â”€ issues_raw.json
â”‚
â””â”€â”€ scripts/                   # One-off and utility scripts
    â””â”€â”€ generate_cleanup_proposal.py
    â””â”€â”€ generate_routstr_report.py
```

---

## ğŸš€ Quick Start

Get up and running in just a few commands!

### 1. Prerequisites

* **Python 3.9+**
* **[uv](https://github.com/astral-sh/uv)**: The modern Python package installer.
* **A Routstr API Key**: For generating narrative reports. Get one from [Routstr](https://routstr.com/).

### 2. Installation

Clone the repository and install the project with `uv`:

```bash
# Clone the repository
git clone https://github.com/therealcheebs/repo-health-analyzer.git
cd repo-health-analyzer

# Install the project and its dependencies
uv sync

# Install development dependencies
uv sync --group dev
```

### 3. Configuration

Create a `.env` file in the root directory by copying the example:

```bash
cp .env.example .env
```

Edit the `.env` file with your credentials and repository information:

```ini
# GitHub Personal Access Token
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxx

# Repository information
GITHUB_OWNER=your_owner
GITHUB_REPO=your_repo

# Start date for fetching data (YYYY-MM-DD)
START_DATE=2022-09-01

# Routstr API Key for LLM reports
ROUTSTR_API_KEY=sk-xxxxxxxxxxxxxxxx
```

---

## ğŸ“‹ Detailed Usage

The `repo-health` command-line interface provides several subcommands.

### `repo-health fetch`

This command connects to the GitHub GraphQL API to pull the latest PR and issue data, including labels and user IDs.

```bash
uv run repo-health fetch [OPTIONS]
```

**Options:**

* `--output-dir PATH`: The directory where the raw JSON data (`prs_raw.json`, `issues_raw.json`) will be saved. Defaults to `data/`.

### `repo-health generate`

This command reads the raw JSON data, normalizes it, calculates all metrics, and saves the final report to `repo_health.json`.

```bash
uv run repo-health generate [OPTIONS]
```

**Options:**

* `--data-dir PATH`: The directory containing the raw JSON data. Defaults to `data/`.
* `--output PATH`: The file path for the generated metrics report. Defaults to `repo_health.json`.

### `repo-health score`

This command calculates and displays a deterministic 0-100 health score based on the metrics in `repo_health.json`.

```bash
uv run repo-health score [OPTIONS]
```

**Options:**

* `--metrics-file PATH`: Path to the generated metrics JSON file. Defaults to `repo_health.json`.
* `--save-to-metrics`: If set, saves the score back into the metrics file for historical tracking.

### `repo-health summary`

This is the recommended command for preparing data for an LLM. It generates a lean, cost-effective summary report containing only the most important information: scores, risk flags, and stalled actions.

```bash
uv run repo-health summary [OPTIONS]
```

**Options:**

* `--data-dir PATH`: Directory containing the fetched raw JSON files. Defaults to `data/`.
* `--output PATH`: Path for the lean summary report JSON file. Defaults to `summary_report.json`.

### `repo-health report`

This command generates a comprehensive report (`final_report.json`) that includes all historical data, scores, and risk analysis. Use this for deep-dive analysis, but prefer the `summary` command for LLM input.

```bash
uv run repo-health report [OPTIONS]
```

**Options:**

* `--data-dir PATH`: Directory containing the fetched raw JSON files. Defaults to `data/`.
* `--output PATH`: Path for the final report JSON file. Defaults to `final_report.json`.

---

## ğŸ§¹ Backlog Cleanup Workflow

The `generate_cleanup_proposal.py` script helps analyze open items and propose labels.

**Run the script:**

```bash
uv run python scripts/generate_cleanup_proposal.py
```

**Options:**

* `--data-dir PATH`: Directory containing the fetched raw JSON files. Defaults to `data/`.
* `--output PATH`: Output file for the cleanup proposal. Defaults to `data/cleanup_proposal.json`.
* `--taxonomy-file PATH`: Path to the JSON file containing the label taxonomy. Defaults to `label_taxonomy.json`.

You can customize the labeling logic by editing `label_taxonomy.json`.

---

## ğŸ¤– LLM-Powered Narrative Reports

This project supports generating a human-readable Markdown report from the JSON data using the `routstr` service.

### The Recommended Workflow

The process is decoupled into two clean steps for maximum efficiency and cost-effectiveness:

1. **Generate the Lean Data**: Use the `summary` command to create a small, focused JSON file.

    ```bash
    uv run repo-health summary
    ```

2. **Generate the Narrative**: Use a separate Python script to send the summary data to `routstr` and get the Markdown report.

    ```bash
    uv run python scripts/generate_routstr_report.py
    ```

The `generate_routstr_report.py` script uses the standard `openai` library, configured to point at the `routstr` proxy. It uses a Jinja2 template (`report_prompt.md`) to structure the prompt sent to the LLM.

---

## ğŸ› ï¸ Development

This section is for developers who want to contribute to the project.

### Setting up the Development Environment

1. **Fork and Clone**:

    ```bash
    git clone https://github.com/your_username/repo-health-analyzer.git
    cd repo-health-analyzer
    ```

2. **Install with `uv`**:

    ```bash
    uv sync
    uv sync --group dev
    ```

### Running Tests

We use `pytest` for testing. Run the test suite with `uv`:

```bash
# Run all tests
uv run pytest

# Run tests with coverage
uv run pytest --cov=src/repo_health --cov-report=html
```

---

## ğŸ”„ Weekly Agent Workflow (CI/CD)

Integrating this tool into a weekly automation job is straightforward.

**Example Cron Job:**

```bash
# Every Monday at 3:00 AM UTC: Fetch data
0 3 * * MON cd /path/to/repo-health-analyzer && /usr/local/bin/uv run repo-health fetch

# Every Monday at 4:00 AM UTC: Generate the lean summary report
0 4 * * MON cd /path/to/repo-health-analyzer && /usr/local/bin/uv run repo-health summary

# Every Monday at 4:05 AM UTC: Generate the narrative report
5 4 * * MON cd /path/to/repo-health-analyzer && /usr/local/bin/uv run python scripts/generate_routstr_report.py
```

---

## ğŸ¤ Contributing

Contributions are welcome! Please feel free to submit a Pull Request. For major changes, please open an issue first to discuss what you would like to change.

---

## ğŸ“„ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.
