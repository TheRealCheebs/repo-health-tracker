# Repo Health Analyzer

[![uv](https://img.shields.io/badge/uv-0.1.0-blue.svg)](https://github.com/astral-sh/uv)
[![Python 3.9+](https://img.shields.io/badge/python-3.9+-blue.svg)](https://www.python.org/downloads/)
[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)

This project provides a system to analyze the health of a GitHub repository over time. It collects raw pull request (PR) and issue data using GitHub GraphQL, normalizes it, and generates detailed metrics such as contributor activity, merge times, response times, backlog, and new contributor growth. The system is designed to be run incrementally on a weekly basis, providing a historical and rolling view of repository health.

---

## âœ¨ Features

* **Historical Data Analysis**: Bootstraps and analyzes repository data from a configurable start date.
* **Comprehensive Metrics**: Calculates strategy, execution, community, and backlog metrics.
* **Time-Series Analysis**: Provides monthly and rolling window metrics for trend analysis.
* **Robust Contributor Tracking**: Tracks contributors using a persistent GitHub User ID, correctly handling deleted or renamed accounts for accurate historical analysis.
* **Contributor Insights**: Tracks new vs. returning contributors and contributor "stickiness".
* **CLI-First**: A clean, modern command-line interface built with `click`.
* **Backlog Cleanup Tools**: Includes a script to help propose labels for open issues and PRs to aid in backlog management.
* **Modern Tooling**: Uses `uv` for fast, reliable dependency management and packaging.

---

## ğŸ“ Project Structure

The project is structured as a proper Python package for better maintainability and scalability.

```
repo-health-analyzer/
â”‚
â”œâ”€â”€ .env.example               # Template for environment variables
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”œâ”€â”€ pyproject.toml             # Project metadata and dependencies
â”œâ”€â”€ uv.lock                    # Lock file generated by uv
â”‚
â”œâ”€â”€ src/
â”‚   â””â”€â”€ repo_health/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ __main__.py        # Entry point for CLI
â”‚       â”œâ”€â”€ cli/               # Command-line interface modules
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ fetch.py       # CLI command for fetching data
â”‚       â”‚   â””â”€â”€ generate.py    # CLI command for generating reports
â”‚       â”œâ”€â”€ config/            # Configuration management
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â””â”€â”€ settings.py    # Settings and environment variables
â”‚       â”œâ”€â”€ data/              # Data processing modules
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â””â”€â”€ fetcher.py     # GraphQL data fetcher and normalizer
â”‚       â”œâ”€â”€ engine/            # Metrics calculation and reporting
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ metrics.py     # Metrics calculation logic
â”‚       â”‚   â””â”€â”€ reporter.py    # Report generation
â”‚       â””â”€â”€ utils/             # Utility functions
â”‚           â”œâ”€â”€ __init__.py
â”‚           â””â”€â”€ helpers.py     # Common helper functions
â”‚
â”œâ”€â”€ tests/                     # Test directory
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ data/                      # Data directory (not in package)
â”‚   â”œâ”€â”€ prs_raw.json
â”‚   â””â”€â”€ issues_raw.json
â”‚
â””â”€â”€ scripts/                   # One-off and utility scripts
    â””â”€â”€ generate_cleanup_proposal.py
```

---

## ğŸš€ Quick Start

Get up and running in just a few commands!

### 1. Prerequisites

* **Python 3.9+**
* **[uv](https://github.com/astral-sh/uv)**: The modern Python package installer.

### 2. Installation

Clone the repository and install the project with `uv`:

```bash
# Clone the repository
git clone https://github.com/your_owner/repo-health-analyzer.git
cd repo-health-analyzer

# Install the project and its dependencies
uv sync
```

### 3. Configuration

Create a `.env` file in the root directory by copying the example:

```bash
cp .env.example .env
```

Edit the `.env` file with your GitHub credentials and repository information:

```ini
# GitHub Personal Access Token
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxx

# Repository information
GITHUB_OWNER=your_owner
GITHUB_REPO=your_repo

# Start date for fetching data (YYYY-MM-DD)
START_DATE=2018-01-01
```

### 4. Run the Analysis

Execute the two main commands to fetch data and generate a report.

```bash
# Fetch the latest PR and issue data from GitHub
uv run repo-health fetch

# Generate the health report from the fetched data
uv run repo-health generate
```

You will find the final report in `repo_health.json`.

---

## ğŸ“‹ Detailed Usage

The `repo-health` command-line interface provides two main subcommands: `fetch` and `generate`.

### `repo-health fetch`

This command connects to the GitHub GraphQL API to pull the latest PR and issue data, including labels and user IDs.

```bash
uv run repo-health fetch [OPTIONS]
```

**Options:**

* `--output-dir PATH`: The directory where the raw JSON data (`prs_raw.json`, `issues_raw.json`) will be saved. Defaults to `data/`.

### `repo-health generate`

This command reads the raw JSON data, normalizes it, calculates all metrics, and saves the final report.

```bash
uv run repo-health generate [OPTIONS]
```

**Options:**

* `--data-dir PATH`: The directory containing the raw JSON data. Defaults to `data/`.
* `--output PATH`: The file path for the generated JSON report. Defaults to `repo_health.json`.

---

## ğŸ§¹ Backlog Cleanup Workflow

Managing a large backlog can be challenging. This project includes a helper script to analyze open items and propose labels based on historical usage.

### `generate_cleanup_proposal.py`

This script analyzes the open PRs and issues in your fetched data to suggest labels, helping you categorize and triage your backlog.

**Run the script:**

```bash
uv run python scripts/generate_cleanup_proposal.py
```

**Options:**

* `--data-dir PATH`: Directory containing the fetched raw JSON files. Defaults to `data/`.
* `--output PATH`: Output file for the cleanup proposal. Defaults to `data/cleanup_proposal.json`.

The output will be a JSON file listing each open PR and issue, its current labels, and a `suggested_labels` field.

---

## ğŸ“ˆ Analysis Features

* **Historical Bootstrapping**: Analyzes repository history from a configurable `START_DATE`.
* **Rolling Window Metrics**: Calculates metrics for the last 90, 180, and 365 days.
* **Contributor Cohort Tracking**:
  * New vs. returning contributors.
  * Contributor stickiness (return rate).
* **PR and Issue Backlog Analysis**: Tracks open items and their age.
* **Reviewer Concentration**: Identifies key reviewers and potential bottlenecks.
* **First Response Analysis**: Measures the time to first comment or review.
* **Robust User Tracking**: Uses GitHub's internal `databaseId` to track contributors, ensuring accuracy even if users are deleted or rename their accounts.

---

## ğŸ› ï¸ Development

This section is for developers who want to contribute to the project.

### Setting up the Development Environment

1. **Fork and Clone**:

    ```bash
    git clone https://github.com/your_username/repo-health-analyzer.git
    cd repo-health-analyzer
    ```

2. **Install with `uv`**:

    ```bash
    uv sync
    ```

### Running Tests

We use `pytest` for testing. Run the test suite with `uv`:

```bash
# Run all tests
uv run pytest

# Run tests with coverage
uv run pytest --cov=src/repo_health --cov-report=html
```

---

## ğŸ”„ Weekly Agent Workflow (CI/CD)

Integrating this tool into a weekly automation job is straightforward.

**Example Cron Job:**

```bash
# Every Monday at 3:00 AM UTC: Fetch data
0 3 * * MON cd /path/to/repo-health-analyzer && /usr/local/bin/uv run repo-health fetch

# Every Monday at 4:00 AM UTC: Generate report
0 4 * * MON cd /path/to/repo-health-analyzer && /usr/local/bin/uv run repo-health generate
```

---

## ğŸ¤ Contributing

Contributions are welcome! Please feel free to submit a Pull Request. For major changes, please open an issue first to discuss what you would like to change.

---

## ğŸ“„ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.
